version: "3.7"
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time args - these come from .env file automatically
        MONGODB_URI: ${MONGODB_URI:-mongodb://mongodb:27017/careers-page}
        DATABASE_URL: ${DATABASE_URL:-mongodb://mongodb:27017/careers-page}
        S3_ENDPOINT: ${S3_ENDPOINT}
        S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
        S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
        S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL}
        NEXT_PUBLIC_STORAGE_BUCKET: ${NEXT_PUBLIC_STORAGE_BUCKET}
        S3_REGION: ${S3_REGION}
        AUTH_SECRET: ${AUTH_SECRET}
        AUTH_GOOGLE_ID: ${AUTH_GOOGLE_ID}
        AUTH_GOOGLE_SECRET: ${AUTH_GOOGLE_SECRET}
        AUTH_URL: ${AUTH_URL:-http://localhost:3016}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3016}
    container_name: careers-page-app
    restart: always
    ports:
      - "3016:3000"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      # Runtime environment variables - these come from .env file automatically
      # Docker Compose automatically reads .env file in the same directory
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongodb:27017/careers-page}
      - DATABASE_URL=${DATABASE_URL:-mongodb://mongodb:27017/careers-page}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3016}
      - AUTH_URL=${AUTH_URL:-http://localhost:3016}
      - AUTH_SECRET=${AUTH_SECRET}
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_PUBLIC_BASE_URL=${S3_PUBLIC_BASE_URL}
      - NEXT_PUBLIC_STORAGE_BUCKET=${NEXT_PUBLIC_STORAGE_BUCKET}
      - S3_REGION=${S3_REGION}

    depends_on:
      - mongodb
    networks:
      - app-network

  mongodb:
    image: mongo:latest
    container_name: careers-page-mongodb
    restart: always
    ports:
      - "27042:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - app-network

volumes:
  mongodb_data:

networks:
  app-network:
    driver: bridge
